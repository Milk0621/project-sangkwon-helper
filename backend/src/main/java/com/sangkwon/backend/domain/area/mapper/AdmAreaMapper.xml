<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.sangkwon.backend.domain.area.mapper.mybatis.AdmAreaMapper">
  	
  	<!-- 시/도 목록 및 상가 수 (카테고리 필터 선택적) -->
	<select id="listSidoStats" resultType="com.sangkwon.backend.domain.area.dto.AreaCountDTO">
		SELECT
		  a.ctprvnNm AS name,
		  COALESCE(SUM(p.cnt), 0) AS `count`
		FROM adm_area a
		LEFT JOIN (
			SELECT
			  adongCd,
			  SUM(store_cnt) AS cnt
			FROM emd_upjong_counts
			<where>
			  <if test="lclsCode != null and lclsCode != ''">
			    AND indsLclsCd = #{lclsCode}
			  </if>
			  <if test="mclsCode != null and mclsCode != ''">
			    AND indsMclsCd = #{mclsCode}
			  </if>
			  <if test="sclsCode != null and sclsCode != ''">
			    AND indsSclsCd = #{sclsCode}
			  </if>
			</where>
			GROUP BY adongCd
		) p ON p.adongCd = a.adongCd
		GROUP BY a.ctprvnNm
		HAVING name IS NOT NULL AND name != ''
		ORDER BY `count` DESC, name ASC
	</select>
  	
  	<!-- 특정 시/도의 구/군 목록 및 상가 수 -->
  	<select id="listSigunguStats" resultType="com.sangkwon.backend.domain.area.dto.AreaCountDTO">
	SELECT
    	a.signguNm AS name,
    	COALESCE(SUM(p.cnt), 0) AS `count`
    FROM adm_area a
    LEFT JOIN (
		SELECT
	        adongCd,
	        SUM(store_cnt) AS cnt
      	FROM emd_upjong_counts
		<where>
			<if test="lclsCode != null and lclsCode != ''">
				AND indsLclsCd = #{lclsCode}
			</if>
			<if test="mclsCode != null and mclsCode != ''">
				AND indsMclsCd = #{mclsCode}
			</if>
			<if test="sclsCode != null and sclsCode != ''">
				AND indsSclsCd = #{sclsCode}
			</if>
		</where>
		GROUP BY adongCd
    ) p ON p.adongCd = a.adongCd
    WHERE a.ctprvnNm = #{sido}
    GROUP BY a.signguNm
    HAVING name IS NOT NULL AND name != ''
    ORDER BY `count` DESC, name ASC
  	</select>
  	
 	<!-- 특정 시/도의 구/군의 동 목록 및 별 상가 수 -->
 	<select id="listDongStats" resultType="com.sangkwon.backend.domain.area.dto.AdongWithCenterDTO">
    SELECT
		a.adongNm AS name,
		COALESCE(SUM(p.cnt), 0) AS `count`,
		c.center_lat AS centerLat,
		c.center_lng AS centerLng
    FROM adm_area a
    LEFT JOIN area_center_dong c
		ON c.adongCd = a.adongCd
    LEFT JOIN (
		SELECT
			adongCd,
			SUM(store_cnt) AS cnt
		FROM emd_upjong_counts
		<where>
			<if test="lclsCode != null and lclsCode != ''">
				AND indsLclsCd = #{lclsCode}
			</if>
			<if test="mclsCode != null and mclsCode != ''">
				AND indsMclsCd = #{mclsCode}
			</if>
			<if test="sclsCode != null and sclsCode != ''">
				AND indsSclsCd = #{sclsCode}
			</if>
		</where>
		GROUP BY adongCd
    ) p ON p.adongCd = a.adongCd
    WHERE a.ctprvnNm = #{sido}
      AND a.signguNm = #{sigungu}
    GROUP BY a.adongNm, c.center_lat, c.center_lng
    ORDER BY `count` DESC, name ASC
 	</select>
 
	<!-- 구 중심좌표 -->
 	<select id="getSigunguCenter" resultType="com.sangkwon.backend.domain.area.dto.SigunguCenterDTO">
 		SELECT
 			ctprvnNm AS sido,
 			signguNm AS sigungu,
 			center_lat AS centerLat,
 			center_lng AS centerLng
 		FROM area_center_gu
 		WHERE ctprvnNm = #{sido} 
	 		AND signguNm = #{sigungu}
 	</select>
 	
 	<!-- 동 중심좌표 -->
 	<select id="getDongCenter" resultType="com.sangkwon.backend.domain.area.dto.AdongCenterDTO">
 		SELECT
 			adongCd AS adongCd,
 			ctprvnNm AS sido,
 			signguNm AS sigungu,
 			adongNm AS dong,
 			center_lat AS centerLat,
 			center_lng AS centerLng
 		FROM area_center_dong
 		WHERE ctprvnNm = #{sido} 
	 		AND signguNm = #{sigungu}
	 		AND adongNm = #{dong}
 	</select>
 	
  </mapper>